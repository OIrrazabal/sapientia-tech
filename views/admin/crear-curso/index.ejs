<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>eLEARNING - Crear Curso</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

<!-- Favicon -->
<link href="/assets/img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="/assets/lib/animate/animate.min.css" rel="stylesheet">
    <link href="/assets/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="/assets/css/style.css" rel="stylesheet">
</head>
<body>
    <%- include('../../partials/navbar') %>

    <div class="container py-5">
        <h2 class="mb-4 text-center"><%= editando ? 'Editar Curso' : 'Crear Nuevo Curso' %></h2>

        <form action="/admin/crear-curso<%= editando ? '/' + curso.id : '' %>" method="POST" enctype="multipart/form-data" class="bg-light p-4 rounded shadow-sm">
            <div class="mb-3">
                <label for="nombre" class="form-label">Nombre del Curso</label>
                <input type="text" class="form-control" name="nombre" value="<%= curso.nombre || '' %>" required>
            </div>

            <div class="mb-3">
                <label for="descripcion" class="form-label">Descripción</label>
                <textarea name="descripcion" class="form-control" required><%= curso.descripcion || '' %></textarea>
            </div>

            <div class="mb-3">
                <label for="categoria_id" class="form-label">Categoría</label>
                <select name="categoria_id" class="form-control" required>
                    <option value="">-- Seleccionar Categoría --</option>
                    <% if (categorias && categorias.length > 0) { %>
                        <% categorias.forEach(categoria => { %>
                            <option value="<%= categoria.id %>" <%= (curso.categoria_id == categoria.id) ? 'selected' : '' %>><%= categoria.nombre %></option>
                        <% }) %>
                    <% } %>
                </select>
            </div>

            <% if (editando) { %>
                <div class="mb-3">
                    <label class="form-label">Imagen actual</label><br>
                    <img 
                        id="curso-imagen-actual"
                        src="/assets/cursos/<%= curso.id %>.jpg" 
                        data-fallback-png="/assets/cursos/<%= curso.id %>.png"
                        data-fallback-jpeg="/assets/cursos/<%= curso.id %>.jpeg"
                        data-fallback-webp="/assets/cursos/<%= curso.id %>.webp"
                        data-fallback-default="/assets/cursos/default.png"
                        onerror="handleImageError(this)"
                        width="160"
                        class="img-thumbnail"
                    >
                    <script>
                        function handleImageError(img) {
                            console.log('Error al cargar imagen, intentando con otras extensiones');
                            
                            // Intenta cargar PNG si JPG falla
                            if (img.src === img.getAttribute('src')) {
                                console.log('Intentando cargar PNG');
                                img.src = img.getAttribute('data-fallback-png');
                                return;
                            }
                            // Intenta cargar JPEG si PNG falla
                            if (img.src === img.getAttribute('data-fallback-png')) {
                                console.log('Intentando cargar JPEG');
                                img.src = img.getAttribute('data-fallback-jpeg');
                                return;
                            }
                            // Intenta cargar WEBP si JPEG falla
                            if (img.src === img.getAttribute('data-fallback-jpeg')) {
                                console.log('Intentando cargar WEBP');
                                img.src = img.getAttribute('data-fallback-webp');
                                return;
                            }
                            // Si todo falla, usa la imagen por defecto
                            console.log('Usando imagen por defecto');
                            img.src = img.getAttribute('data-fallback-default');
                            img.onerror = null; // Previene bucles infinitos
                        }
                        
                        // Forzar recarga de imagen al cargar la página para evitar caché
                        document.addEventListener('DOMContentLoaded', function() {
                            const img = document.getElementById('curso-imagen-actual');
                            if (img) {
                                const timestamp = new Date().getTime();
                                img.src = img.src + '?t=' + timestamp;
                                console.log('Recargando imagen actual:', img.src);
                            }
                        });
                    </script>
                </div>
            <% } %>

            <div class="mb-3">
                <label for="imagen" class="form-label">Imagen nueva (opcional)</label>
                <input type="file" class="form-control" name="imagen" accept=".jpg,.jpeg,.png,.webp" id="curso-imagen-input">
                <small class="text-muted">Formatos aceptados: JPG, JPEG, PNG, WEBP. Tamaño máximo: 5MB</small>
                
                <% if (editando) { %>
                <div class="form-text">
                    <p class="mb-0"><strong>Nota:</strong> Al subir una nueva imagen, se reemplazará la imagen anterior.</p>
                </div>
                <% } %>
            </div>

            <div class="d-flex justify-content-between">
                <a href="/admin/home" class="btn btn-secondary px-4">Cancelar</a>
                <button type="submit" class="btn btn-primary px-4"><%= editando ? 'Guardar Cambios' : 'Crear Curso' %></button>
            </div>
        </form>
    </div>

    <%- include('../../partials/footer') %>
</body>
</html>